<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ“¸ InsChat â€” Feed</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .carousel { position: relative; overflow: hidden; }
    .carousel-track { display:flex; transition: transform 0.3s ease-in-out; scroll-snap-type: x mandatory; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .carousel-track img { flex:0 0 100%; scroll-snap-align:center; object-fit:cover; max-height: 650px; width:100%; }
    .carousel-btn { position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.45); color:white; padding:8px 12px; border-radius:9999px; font-size:22px; }
    .carousel-btn.left { left:10px; } .carousel-btn.right { right:10px; }

    .like-heart {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%) scale(0);
      font-size:4.5rem; color:white;
      opacity:0; pointer-events:none;
      transition: transform .25s ease, opacity .25s ease;
    }
    .like-heart.show { transform:translate(-50%,-50%) scale(1); opacity:1; }

    .no-scrollbar::-webkit-scrollbar { display:none; }

    .story-ring { padding:3px; background: linear-gradient(45deg,#feda75,#fa7e1e,#d62976,#962fbf,#4f5bd5); border-radius:9999px; }
  </style>
</head>

<body class="bg-gray-100">

  <!-- NAVBAR -->
  <div class="flex items-center justify-between p-4 bg-white shadow">
    <h1 class="text-xl font-bold">InsChat</h1>

    <div class="flex space-x-4 text-xl">
      <a href="/posts/upload">â•</a>
      <a href="/auth/logout">ğŸšª</a>
    </div>
  </div>

  <!-- STORIES -->
  <div class="bg-white border-b p-3 overflow-x-auto flex space-x-4 no-scrollbar">
    {% for i in range(8) %}
    <div class="flex flex-col items-center text-xs">
      <div class="story-ring w-16 h-16 rounded-full flex items-center justify-center">
        <img src="https://i.pravatar.cc/150?img={{ i }}" class="w-14 h-14 rounded-full" />
      </div>
      <span class="mt-1 text-gray-600">user{{ i }}</span>
    </div>
    {% endfor %}
  </div>

  <!-- FEED -->
  <div class="max-w-xl mx-auto mt-4 space-y-6 pb-24">
    {% for post in posts %}
    <div class="bg-white rounded-xl shadow overflow-hidden">

      <!-- HEADER -->
      <div class="flex items-center justify-between px-4 py-3">
        <div class="flex items-center space-x-3">
          <div class="story-ring w-10 h-10 rounded-full flex items-center justify-center">
            <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white bg-gradient-to-r from-pink-500 to-yellow-500">
              {{ post.user[0]|upper }}
            </div>
          </div>
          <div class="font-semibold">{{ post.user }}</div>
        </div>

        {% if post.user == current_user %}
        <form method="POST" action="/posts/delete/{{ post.id }}">
          <button class="text-red-500 text-sm">Delete</button>
        </form>
        {% endif %}
      </div>

      <!-- IMAGES (CAROUSEL + DOUBLE TAP) -->
      <div class="relative">

        <!-- MULTIPLE IMAGES -->
        {% if post.images and post.images|length > 1 %}
        <div class="carousel">
          <div id="track-{{ post.id }}" class="carousel-track no-scrollbar">
            {% for img in post.images %}
            <img src="{{ url_for('static', filename='uploads/' ~ img) }}"
                 ondblclick="toggleLike({{ post.id }}, document.querySelector('#like-btn-{{ post.id }}'))"
                 ontouchend="onImageTap({{ post.id }})">
            {% endfor %}
          </div>

          <button class="carousel-btn left" onclick="scrollByTrack('{{ post.id }}', -1)">â€¹</button>
          <button class="carousel-btn right" onclick="scrollByTrack('{{ post.id }}', +1)">â€º</button>
        </div>

        <!-- SINGLE IMAGE -->
        {% elif post.images and post.images|length == 1 %}
        <img src="{{ url_for('static', filename='uploads/' ~ post.images[0]) }}"
             class="w-full max-h-[650px] object-cover"
             ondblclick="toggleLike({{ post.id }}, document.querySelector('#like-btn-{{ post.id }}'))"
             ontouchend="onImageTap({{ post.id }})">
        {% endif %}

        <!-- HEART ANIMATION -->
        <div id="heart-{{ post.id }}" class="like-heart">â¤ï¸</div>
      </div>

      <!-- ACTION BUTTONS -->
      <div class="flex items-center px-4 py-2 space-x-4 text-2xl">
        <button id="like-btn-{{ post.id }}"
                onclick="toggleLike({{ post.id }}, this)">â¤ï¸</button>

        <a href="#comment-{{ post.id }}">ğŸ’¬</a>
      </div>

      <!-- LIKES + CAPTION -->
<div class="px-4 pb-2">
  <div id="like-count-{{ post.id }}" class="text-sm font-semibold">
      {{ post.likes }} likes
  </div>

  <div class="text-sm">
    <span class="font-semibold">{{ post.user }}</span> {{ post.caption }}
  </div>
</div>    

      <!-- COMMENTS -->
      <div class="px-4 pb-3 text-sm text-gray-700 space-y-1">
        {% for c in post.comments %}
        <p><span class="font-semibold">{{ c.username }}</span> {{ c.comment }}</p>
        {% endfor %}
      </div>

      <!-- ADD COMMENT -->
      <form id="comment-{{ post.id }}" method="POST"
            action="/posts/comment/{{ post.id }}"
            class="px-4 pb-4 flex items-center space-x-2">
        <input name="comment" placeholder="Add a comment..." required
               class="flex-grow rounded-lg border px-3 py-2 text-sm" />
        <button class="text-blue-500 font-semibold">Post</button>
      </form>

    </div>
    {% endfor %}
  </div>

  <!-- BOTTOM NAV -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-inner flex justify-around py-2 text-2xl">
    <a href="/posts/feed">ğŸ </a>
    <a href="#">ğŸ”</a>
    <a href="/posts/upload">â•</a>
    <a href="#">ğŸ¬</a>
    <a href="/profile/{{ current_user }}">ğŸ‘¤</a>
  </div>

<script>

  /* ============= LIKE (AJAX + ANIMATION) ============= */

async function toggleLike(postId, btnEl) {
  const res = await fetch(`/social/posts/like/${postId}`, {
    method: "POST",
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });

  const j = await res.json();
  if (!j.ok) return alert("Login required");

  const heart = document.getElementById(`heart-${postId}`);
  const countEl = document.getElementById(`like-count-${postId}`);

  if (j.action === "liked") {
    btnEl.classList.add("text-red-600");

    // â¤ï¸ animation
    heart.classList.add("show");
    setTimeout(() => heart.classList.remove("show"), 800);
  } else {
    btnEl.classList.remove("text-red-600");
  }

  // Like count update
  if (j.count !== undefined) {
    countEl.innerText = `${j.count} likes`;
  }
}

</script>

</body>
</html>
